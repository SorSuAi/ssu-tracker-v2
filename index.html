<!DOCTYPE html>
<html lang="en">
<head>
    <title>SSU Tracker Pro | Unified System</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 10px; background: #f0f2f5; color: #333; margin: 0; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin: 10px; border-top: 5px solid #002147; }
        h2 { color: #002147; margin: 10px 0; }
        .mode-container { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; }
        button { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-mode { flex: 1; background: #e0e0e0; max-width: 100px; }
        .btn-mode.active { background: #002147; color: white; }
        .btn-action { width: 90%; background: #28a745; color: white; font-size: 1.1em; padding: 15px; margin-top: 10px; }
        
        #video-container { display: block; width: 90%; max-width: 400px; margin: 10px auto; border-radius: 12px; overflow: hidden; position: relative; border: 3px solid #002147; }
        video { width: 100%; display: block; background: #000; }
        #scanner-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; border: 15px solid rgba(0,0,0,0.2); box-sizing: border-box; }
        .grid-line { border-bottom: 1px dashed rgba(255,255,255,0.4); width: 100%; }

        #key-editor-container { display: none; margin-top: 10px; background: #fafafa; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
        #key-list { max-height: 150px; overflow-y: auto; text-align: left; margin-bottom: 10px; font-size: 0.9em; }
        .key-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 3px 0; }
        textarea { width: 90%; height: 60px; font-family: monospace; padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
        
        .history-card { margin-top: 20px; border-top: 5px solid #6c757d; text-align: left; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8em; }
        th { background: #eee; padding: 8px; text-align: left; }
        td { border-bottom: 1px solid #eee; padding: 8px; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.75em; color: white; }
        
        input[type="text"], select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; width: 85%; }
        #status { font-weight: bold; padding: 8px; margin-top: 10px; display: inline-block; color: #002147; }
    </style>
</head>
<body>

    <h2>üèõÔ∏è SSU Tracker Pro</h2>
    
    <div class="card">
        <div class="mode-container">
            <button id="btnAttendance" class="btn-mode active" onclick="setMode('Attendance')">Attend</button>
            <button id="btnRecitation" class="btn-mode" onclick="setMode('Recitation')">Recit</button>
            <button id="btnGrader" class="btn-mode" onclick="setMode('Grader')">Grader</button>
        </div>

        <div id="graderControls" style="display:none;">
            <label><b>Exam Items:</b></label>
            <select id="itemCount" onchange="initAnswerKey()">
                <option value="15">15 Items</option>
                <option value="20">20 Items</option>
                <option value="30" selected>30 Items</option>
                <option value="45">45 Items</option>
                <option value="60">60 Items</option>
            </select>
            <button onclick="toggleKeyEditor()" style="background:#6c757d; color:white; width:90%; margin-top:5px; padding:8px;">‚öôÔ∏è Manage Answer Key</button>
            
            <div id="key-editor-container">
                <strong>Bulk Paste (e.g. ABCD...)</strong><br>
                <textarea id="bulkInput" placeholder="Paste ABCD string..." oninput="parseBulkAnswers()"></textarea>
                <div id="key-list"></div>
            </div>
            <button onclick="openPrintableSheet()" style="background:#007bff; color:white; width:90%; margin-top:5px; padding:8px;">üìÑ Open Printable Sheet</button>
        </div>
    </div>

    <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <div id="scanner-overlay"></div>
    </div>

    <div class="card">
        <div id="status">Tap Screen to Enable Beep</div>
        <input type="text" id="manualId" placeholder="Manual ID / Scan Result">
        <button id="actionBtn" class="btn-action" onclick="handleAction()">Log Entry</button>
    </div>

    <div class="card history-card">
        <strong>üïí Recent Activity</strong>
        <table id="historyTable">
            <thead>
                <tr><th>Time</th><th>ID</th><th>Mode</th><th>Result</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <canvas id="procCanvas" style="display:none;"></canvas>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbx5sZG0zIJhkB8P6LjKolCrwXXuDzfsrYWU8enK4Ln_cZS9UwcBX__PHLixbYCjnoKJ/exec"; 
        let currentMode = "Attendance";
        let answerKey = [];
        let isScanning = false;
        const charMap = { 'A':0, 'B':1, 'C':2, 'D':3, '0':0, '1':1, '2':2, '3':3 };

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
            document.getElementById('btn' + mode).classList.add('active');
            
            const isGrader = (mode === 'Grader');
            document.getElementById('graderControls').style.display = isGrader ? 'block' : 'none';
            document.getElementById('actionBtn').innerText = isGrader ? "Scan & Grade" : "Log Entry";
            
            if(isGrader) {
                initAnswerKey();
                document.getElementById('scanner-overlay').innerHTML = ''; // Specific layout handled by grader logic later
            } else {
                document.getElementById('scanner-overlay').innerHTML = '';
                startBarcodeLoop();
            }
            playBeep(440, 50);
        }

        function openPrintableSheet() {
            const items = document.getElementById('itemCount').value;
            window.open(`sheet.html?items=${items}`, '_blank');
        }

        async function startCamera() {
            const video = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.onloadedmetadata = () => { if(currentMode !== 'Grader') startBarcodeLoop(); };
            } catch (err) { document.getElementById('status').innerText = "Camera Access Required"; }
        }

        async function startBarcodeLoop() {
            if (isScanning || !('BarcodeDetector' in window)) return;
            isScanning = true;
            const detector = new BarcodeDetector();
            const video = document.getElementById('video');

            async function scan() {
                if (currentMode === 'Grader') { isScanning = false; return; }
                try {
                    const barcodes = await detector.detect(video);
                    if (barcodes.length > 0) {
                        const id = barcodes[0].rawValue;
                        document.getElementById('manualId').value = id;
                        handleAction();
                        setTimeout(() => requestAnimationFrame(scan), 3000); 
                        return;
                    }
                } catch (e) {}
                requestAnimationFrame(scan);
            }
            scan();
        }

        function handleAction() {
            const id = document.getElementById('manualId').value;
            if (currentMode === 'Grader') {
                processGrader();
            } else if (currentMode === 'Recitation') {
                if (!id) return alert("Enter Student ID");
                let s = prompt(`Score for ${id}:`, "1");
                if (s !== null) logData(id, s);
            } else {
                if (!id) return alert("Enter Student ID");
                logData(id, "Present");
            }
        }

        function processGrader() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('procCanvas');
            const ctx = canvas.getContext('2d');
            const items = answerKey.length;
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            let score = 0;
            const stepY = canvas.height / (items + 1);
            const stepX = canvas.width / 5;

            for (let i = 0; i < items; i++) {
                let options = [];
                for (let j = 0; j < 4; j++) {
                    const x = (j + 1) * stepX;
                    const y = (i + 1) * stepY;
                    const img = ctx.getImageData(x, y, 5, 5).data;
                    options.push({ val: (img[0]+img[1]+img[2])/3, index: j });
                }
                options.sort((a, b) => a.val - b.val);
                if (options[0].val < 115 && options[0].index === answerKey[i]) score++;
            }
            logData(document.getElementById('manualId').value || "Auto_Scan", score);
        }

        function logData(id, val) {
            const url = `${scriptURL}?id=${encodeURIComponent(id)}&type=${encodeURIComponent(currentMode)}&score=${encodeURIComponent(val)}`;
            document.getElementById('status').innerText = "Syncing...";
            fetch(url, { method: "GET", mode: "no-cors" })
                .then(() => {
                    document.getElementById('status').innerText = "‚úÖ Sent: " + id;
                    addToHistory(id, currentMode, val);
                    playBeep(880, 150);
                })
                .catch(() => {
                    document.getElementById('status').innerText = "üì° Offline Save";
                    addToHistory(id, currentMode, val + " (Offline)");
                    playBeep(440, 200);
                });
        }

        function addToHistory(id, mode, val) {
            const table = document.getElementById('historyTable').getElementsByTagName('tbody')[0];
            const row = table.insertRow(0);
            const colors = { 'Grader': '#6f42c1', 'Recitation': '#fd7e14', 'Attendance': '#007bff' };
            row.innerHTML = `<td>${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</td>
                <td><b>${id}</b></td>
                <td><span class="badge" style="background:${colors[mode]}">${mode}</span></td>
                <td>${val}</td>`;
            if (table.rows.length > 8) table.deleteRow(8);
        }

        function playBeep(f, d) {
            try {
                const a = new (window.AudioContext || window.webkitAudioContext)();
                if (a.state === 'suspended') a.resume();
                const o = a.createOscillator();
                const g = a.createGain();
                o.frequency.value = f;
                o.connect(g); g.connect(a.destination);
                g.gain.value = 0.1;
                o.start(); o.stop(a.currentTime + d/1000);
            } catch(e) { console.log("Audio blocked"); }
        }

        function initAnswerKey() {
            const items = parseInt(document.getElementById('itemCount').value);
            answerKey = new Array(items).fill(0);
            renderKeyList();
            updateGridOverlay(items);
        }

        function renderKeyList() {
            const container = document.getElementById('key-list');
            container.innerHTML = '';
            answerKey.forEach((val, i) => {
                const row = document.createElement('div');
                row.className = 'key-row';
                row.innerHTML = `<span>Q${i+1}</span> 
                    <select onchange="answerKey[${i}] = parseInt(this.value)">
                        <option value="0" ${val==0?'selected':''}>A</option>
                        <option value="1" ${val==1?'selected':''}>B</option>
                        <option value="2" ${val==2?'selected':''}>C</option>
                        <option value="3" ${val==3?'selected':''}>D</option>
                    </select>`;
                container.appendChild(row);
            });
        }

        function parseBulkAnswers() {
            const input = document.getElementById('bulkInput').value.toUpperCase().replace(/[^ABCD0-3]/g, '');
            for (let i = 0; i < Math.min(input.length, answerKey.length); i++) {
                answerKey[i] = charMap[input[i]];
            }
            renderKeyList();
        }

        function toggleKeyEditor() {
            const el = document.getElementById('key-editor-container');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function updateGridOverlay(items) {
            const overlay = document.getElementById('scanner-overlay');
            overlay.innerHTML = '';
            for(let i=0; i<items; i++) {
                const line = document.createElement('div');
                line.className = 'grid-line';
                line.style.height = (100 / items) + "%";
                overlay.appendChild(line);
            }
        }

        window.onload = startCamera;
        document.body.addEventListener('click', () => { if(currentMode !== 'Grader') startBarcodeLoop(); }, {once: false});
    </script>
</body>
</html>