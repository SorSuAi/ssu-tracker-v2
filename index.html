<!DOCTYPE html>
<html>
<head>
    <title>SSU Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9; }
        button { padding: 20px; margin: 10px; width: 80%; font-size: 1.2em; cursor: pointer; border: none; border-radius: 8px; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .active { background-color: #4CAF50 !important; color: white; transform: scale(1.05); }
        #status { margin-top: 20px; font-weight: bold; min-height: 50px; }
        .attendance-btn { background-color: #e0e0e0; }
        .recitation-btn { background-color: #e0e0e0; }
    </style>
    <link rel="manifest" href="manifest.json">
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
    </script>
</head>
<body>
    <h2>üèõÔ∏è SSU Attendance & Recitation</h2>
    <p id="status">Tap a mode to start scanning...</p>
    
    <button id="btnAttendance" class="attendance-btn active" onclick="setMode('Attendance')">Mode: Attendance</button>
    <button id="btnRecitation" class="recitation-btn" onclick="setMode('Recitation')">Mode: Recitation</button>

   <script>
    let currentMode = "Attendance";
    
    // FIXED: Removed the double URL paste
    const scriptURL = "https://script.google.com/macros/s/AKfycbx5sZG0zIJhkB8P6LjKolCrwXXuDzfsrYWU8enK4Ln_cZS9UwcBX__PHLixbYCjnoKJ/exec";

    function playBeep(frequency = 880, duration = 150) {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + (duration / 1000));
        } catch(e) { console.error("Audio error", e); }
    }

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('status').innerText = "Mode set to: " + mode;
        
        // Visual button toggle
        document.getElementById('btnAttendance').classList.toggle('active', mode === 'Attendance');
        document.getElementById('btnRecitation').classList.toggle('active', mode === 'Recitation');
        
        playBeep(440, 50);
    }

    async function startScanning() {
        if ('NDEFReader' in window) {
            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                document.getElementById('status').innerHTML = "üì° <span style='color: blue;'>Scanner Active...</span><br>Tap ID to center-back of phone";

                ndef.onreading = event => {
                    const id = event.serialNumber;
                    logToSheet(id);
                };
            } catch (error) {
                document.getElementById('status').innerText = "Error: " + error;
            }
        } else {
            document.getElementById('status').innerText = "Web NFC not supported on this device.";
        }
    }

    function logToSheet(id) {
    // We explicitly build the URL with parameters
    const urlWithParams = scriptURL + "?id=" + encodeURIComponent(id) + "&type=" + encodeURIComponent(currentMode);

    fetch(urlWithParams, {
        method: "GET",
        mode: "no-cors", // Required for Google Apps Script
    })
    .then(() => {
        // Update the UI
        document.getElementById('status').innerHTML = 
            `<b style="color: green;">‚úÖ Success!</b><br>ID: ${id}<br>Mode: ${currentMode}`;
        
        // Feedbacks
        playBeep(880, 200); 
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]); 
    })
    .catch(err => {
        console.error("Scanning Error:", err);
        document.getElementById('status').innerText = "Sync Error. Check connection.";
    });
}

    document.body.addEventListener('click', () => {
        startScanning();
    }, { once: true });
</script>
</body>
</html>