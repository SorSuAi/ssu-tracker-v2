<!DOCTYPE html>
<html lang="en">
<head>
    <title>SSU Tracker Pro | Unified System</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 10px; background: #f0f2f5; color: #333; margin: 0; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin: 10px; border-top: 5px solid #002147; }
        h2 { color: #002147; margin: 10px 0; }
        .mode-container { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; }
        button { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-mode { flex: 1; background: #e0e0e0; max-width: 100px; }
        .btn-mode.active { background: #002147; color: white; }
        .btn-action { width: 90%; background: #28a745; color: white; font-size: 1.1em; padding: 15px; margin-top: 10px; }
        
        #video-container { display: none; width: 90%; max-width: 400px; margin: 10px auto; border-radius: 12px; overflow: hidden; position: relative; border: 3px solid #002147; }
        video { width: 100%; display: block; }
        #scanner-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; border: 15px solid rgba(0,0,0,0.2); box-sizing: border-box; }
        .grid-line { border-bottom: 1px dashed rgba(255,255,255,0.4); width: 100%; }

        /* Grader Styles */
        #key-editor { display: none; text-align: left; max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #ccc; margin: 10px 0; background: #fafafa; border-radius: 8px; }
        .key-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px solid #eee; padding: 2px 0; }
        
        /* History Table Styles */
        .history-card { margin-top: 20px; border-top: 5px solid #6c757d; text-align: left; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85em; }
        th { background: #eee; padding: 8px; }
        td { border-bottom: 1px solid #eee; padding: 8px; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; color: white; }
        
        input[type="text"], select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; width: 85%; }
        #status { font-weight: bold; padding: 10px; border-radius: 5px; background: #fff; display: inline-block; margin-top: 10px; border: 1px solid #eee; }
    </style>
</head>
<body>

    <h2>üèõÔ∏è SSU Tracker Pro</h2>
    
    <div class="card">
        <div class="mode-container">
            <button id="btnAttendance" class="btn-mode active" onclick="setMode('Attendance')">Attend</button>
            <button id="btnRecitation" class="btn-mode" onclick="setMode('Recitation')">Recit</button>
            <button id="btnGrader" class="btn-mode" onclick="setMode('Grader')">Grader</button>
        </div>

        <div id="graderControls" style="display:none;">
            <label><b>Exam Items:</b></label>
            <select id="itemCount" onchange="initAnswerKey()">
                <option value="15">15 Items</option>
                <option value="20">20 Items</option>
                <option value="25">25 Items</option>
                <option value="30" selected>30 Items</option>
                <option value="45">45 Items</option>
                <option value="60">60 Items</option>
            </select>
            <button onclick="toggleKeyEditor()" style="background:#6c757d; color:white; width:90%; margin-top:5px; padding:8px;">‚öôÔ∏è Edit Answer Key</button>
            <div id="key-editor"></div>
        </div>
    </div>

    <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <div id="scanner-overlay"></div>
    </div>

    <div class="card">
        <div id="status">Ready</div>
        <input type="text" id="manualId" placeholder="Manual ID / Name">
        <button id="actionBtn" class="btn-action" onclick="handleAction()">Log Entry</button>
    </div>

    <div class="card history-card">
        <strong>üïí Recent Activity</strong>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>ID</th>
                    <th>Mode</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <canvas id="procCanvas" style="display:none;"></canvas>

    <script>
        // --- CONFIGURATION ---
        const scriptURL = "YOUR_GOOGLE_SCRIPT_URL"; 
        let currentMode = "Attendance";
        let answerKey = [];
        let logHistory = [];

        // --- CORE UI FUNCTIONS ---
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
            document.getElementById('btn' + mode).classList.add('active');
            
            const isGrader = (mode === 'Grader');
            document.getElementById('graderControls').style.display = isGrader ? 'block' : 'none';
            document.getElementById('video-container').style.display = 'block';
            document.getElementById('actionBtn').innerText = isGrader ? "Scan & Grade" : "Log Entry";
            
            startCamera();
            if(isGrader) {
                initAnswerKey();
            } else {
                document.getElementById('scanner-overlay').innerHTML = ''; 
            }
            playBeep(440, 50);
        }

        async function startCamera() {
            const video = document.getElementById('video');
            if (video.srcObject) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
            } catch (err) { document.getElementById('status').innerText = "Camera Error."; }
        }

        function handleAction() {
            const id = document.getElementById('manualId').value;
            
            if (currentMode === 'Grader') {
                processGrader();
            } else if (currentMode === 'Recitation') {
                if (!id) return alert("Enter Student ID first");
                let score = prompt(`Enter Recitation Score for ${id}:`, "1");
                if (score !== null) logData(id, score);
            } else {
                if (!id) return alert("Enter Student ID first");
                logData(id, "Present");
            }
        }

        // --- GRADER LOGIC ---
        function initAnswerKey() {
            const items = parseInt(document.getElementById('itemCount').value);
            const container = document.getElementById('key-editor');
            container.innerHTML = '<strong>Key (0=A, 1=B, 2=C, 3=D)</strong><br>';
            answerKey = new Array(items).fill(0);
            
            for(let i=0; i<items; i++) {
                const row = document.createElement('div');
                row.className = 'key-row';
                row.innerHTML = `<span>Q${i+1}</span> 
                    <select onchange="answerKey[${i}] = parseInt(this.value)">
                        <option value="0">A</option><option value="1">B</option>
                        <option value="2">C</option><option value="3">D</option>
                    </select>`;
                container.appendChild(row);
            }
            updateGridOverlay(items);
        }

        function toggleKeyEditor() {
            const editor = document.getElementById('key-editor');
            editor.style.display = editor.style.display === 'none' ? 'block' : 'none';
        }

        function updateGridOverlay(items) {
            const overlay = document.getElementById('scanner-overlay');
            overlay.innerHTML = '';
            for(let i=0; i<items; i++) {
                const line = document.createElement('div');
                line.className = 'grid-line';
                line.style.height = (100 / items) + "%";
                overlay.appendChild(line);
            }
        }

        function processGrader() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('procCanvas');
            const ctx = canvas.getContext('2d');
            const items = answerKey.length;
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            let score = 0;
            const stepY = canvas.height / (items + 1);
            const stepX = canvas.width / 5;

            for (let i = 0; i < items; i++) {
                let options = [];
                for (let j = 0; j < 4; j++) {
                    const x = (j + 1) * stepX;
                    const y = (i + 1) * stepY;
                    const imgData = ctx.getImageData(x, y, 5, 5).data;
                    let brightness = (imgData[0] + imgData[1] + imgData[2]) / 3;
                    options.push({ val: brightness, index: j });
                }
                options.sort((a, b) => a.val - b.val);
                if (options[0].val < 120 && options[0].index === answerKey[i]) score++;
            }

            const id = document.getElementById('manualId').value || "Unknown";
            logData(id, score);
        }

        // --- DATA & HISTORY LOGGING ---
        function logData(id, val) {
            const url = `${scriptURL}?id=${encodeURIComponent(id)}&type=${encodeURIComponent(currentMode)}&score=${encodeURIComponent(val)}`;
            
            document.getElementById('status').innerText = "Syncing...";
            fetch(url, { method: "GET", mode: "no-cors" })
                .then(() => {
                    document.getElementById('status').innerText = `‚úÖ Success: ${id}`;
                    addToHistory(id, currentMode, val);
                    playBeep(880, 100);
                })
                .catch(() => {
                    document.getElementById('status').innerText = "üì° Saved Offline";
                    addToHistory(id, currentMode, val + " (Offline)");
                });
        }

        function addToHistory(id, mode, val) {
            const table = document.getElementById('historyTable').getElementsByTagName('tbody')[0];
            const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const row = table.insertRow(0);
            
            let color = mode === 'Grader' ? '#6f42c1' : (mode === 'Recitation' ? '#fd7e14' : '#007bff');
            
            row.innerHTML = `
                <td>${now}</td>
                <td><b>${id}</b></td>
                <td><span class="badge" style="background:${color}">${mode}</span></td>
                <td>${val}</td>
            `;

            // Keep only last 10 entries
            if (table.rows.length > 10) table.deleteRow(10);
        }

        function playBeep(f, d) {
            const a = new (window.AudioContext || window.webkitAudioContext)();
            const o = a.createOscillator();
            o.frequency.value = f;
            o.connect(a.destination);
            o.start(); o.stop(a.currentTime + d/1000);
        }
    </script>
</body>
</html>