<!DOCTYPE html>
<html lang="en">
<head>
    <title>SSU Tracker Pro | Multi-Grader</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 10px; background: #f0f2f5; color: #333; margin: 0; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin: 10px; border-top: 5px solid #002147; }
        h2 { color: #002147; margin: 10px 0; }
        
        .mode-container { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; }
        button { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-mode { flex: 1; background: #e0e0e0; max-width: 100px; }
        .btn-mode.active { background: #002147; color: white; }
        
        .btn-action { width: 90%; background: #28a745; color: white; font-size: 1.1em; padding: 15px; margin-top: 10px; }
        
        #video-container { display: none; width: 90%; max-width: 400px; margin: 10px auto; border-radius: 12px; overflow: hidden; position: relative; border: 3px solid #002147; }
        video { width: 100%; display: block; }
        
        /* Grid Overlay */
        #scanner-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; border: 15px solid rgba(0,0,0,0.2); box-sizing: border-box; }
        .grid-line { border-bottom: 1px dashed rgba(255,255,255,0.4); width: 100%; }

        #key-editor { display: none; text-align: left; max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #ccc; margin: 10px 0; }
        .key-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        input[type="text"], select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; width: 90%; }
        #status { font-weight: bold; color: #002147; margin: 10px; }
    </style>
</head>
<body>

    <h2>üèõÔ∏è SSU Tracker Pro</h2>
    
    <div class="card">
        <div class="mode-container">
            <button id="btnAttendance" class="btn-mode active" onclick="setMode('Attendance')">Attend</button>
            <button id="btnRecitation" class="btn-mode" onclick="setMode('Recitation')">Recit</button>
            <button id="btnGrader" class="btn-mode" onclick="setMode('Grader')">Grader</button>
        </div>

        <div id="graderControls" style="display:none;">
            <label><b>Item Count:</b></label>
            <select id="itemCount" onchange="initAnswerKey()">
                <option value="15">15 Items</option>
                <option value="20">20 Items</option>
                <option value="25">25 Items</option>
                <option value="30" selected>30 Items</option>
                <option value="45">45 Items</option>
                <option value="60">60 Items</option>
            </select>
            
            <button onclick="toggleKeyEditor()" style="background:#6c757d; color:white; width:90%; margin-top:5px;">Edit Answer Key</button>
            <div id="key-editor"></div>
        </div>
    </div>

    <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <div id="scanner-overlay"></div>
    </div>

    <div class="card">
        <div id="status">Ready</div>
        <input type="text" id="manualId" placeholder="Scan or Enter Student ID">
        <button id="actionBtn" class="btn-action" onclick="handleAction()">Submit Entry</button>
    </div>

    <canvas id="procCanvas" style="display:none;"></canvas>

    <script>
        const scriptURL = "YOUR_GOOGLE_SCRIPT_URL"; // Replace with your deployment URL
        let currentMode = "Attendance";
        let answerKey = [];

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
            document.getElementById('btn' + mode).classList.add('active');
            
            const isGrader = mode === 'Grader';
            document.getElementById('graderControls').style.display = isGrader ? 'block' : 'none';
            document.getElementById('video-container').style.display = 'block';
            document.getElementById('actionBtn').innerText = isGrader ? "Scan & Grade" : "Log Entry";
            
            startCamera();
            if(isGrader) initAnswerKey();
        }

        function initAnswerKey() {
            const items = parseInt(document.getElementById('itemCount').value);
            const container = document.getElementById('key-editor');
            container.innerHTML = '<b>Set Correct Answers (A=0, B=1, C=2, D=3):</b><br>';
            answerKey = new Array(items).fill(0);
            
            for(let i=0; i<items; i++) {
                const row = document.createElement('div');
                row.className = 'key-row';
                row.innerHTML = `<span>Q${i+1}:</span> 
                    <select onchange="updateKey(${i}, this.value)">
                        <option value="0">A</option><option value="1">B</option>
                        <option value="2">C</option><option value="3">D</option>
                    </select>`;
                container.appendChild(row);
            }
            updateGridOverlay(items);
        }

        function updateKey(index, val) { answerKey[index] = parseInt(val); }
        function toggleKeyEditor() {
            const editor = document.getElementById('key-editor');
            editor.style.display = editor.style.display === 'none' ? 'block' : 'none';
        }

        function updateGridOverlay(items) {
            const overlay = document.getElementById('scanner-overlay');
            overlay.innerHTML = '';
            for(let i=0; i<items; i++) {
                const line = document.createElement('div');
                line.className = 'grid-line';
                line.style.height = (100 / items) + "%";
                overlay.appendChild(line);
            }
        }

        async function startCamera() {
            const video = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
            } catch (err) { alert("Please allow camera access."); }
        }

        function handleAction() {
            if (currentMode === 'Grader') processGrader();
            else {
                const id = document.getElementById('manualId').value;
                if(id) logData(id, "");
            }
        }

        function processGrader() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('procCanvas');
            const ctx = canvas.getContext('2d');
            const items = answerKey.length;
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            let score = 0;
            const stepY = canvas.height / (items + 1);
            const stepX = canvas.width / 5;

            for (let i = 0; i < items; i++) {
                let options = [];
                for (let j = 0; j < 4; j++) {
                    const x = (j + 1) * stepX;
                    const y = (i + 1) * stepY;
                    const imgData = ctx.getImageData(x, y, 5, 5).data;
                    let brightness = (imgData[0] + imgData[1] + imgData[2]) / 3;
                    options.push({ val: brightness, index: j });
                }
                
                // Find darkest bubble in row
                options.sort((a, b) => a.val - b.val);
                if (options[0].val < 120 && options[0].index === answerKey[i]) {
                    score++;
                }
            }

            const studentId = document.getElementById('manualId').value || "Unknown";
            logData(studentId, score);
            document.getElementById('status').innerText = `ID: ${studentId} | Score: ${score}/${items}`;
            playBeep(880, 150);
        }

        function logData(id, score) {
            const url = `${scriptURL}?id=${encodeURIComponent(id)}&type=${encodeURIComponent(currentMode)}&score=${encodeURIComponent(score)}`;
            fetch(url, { method: "GET", mode: "no-cors" });
            document.getElementById('status').innerText = "Logged: " + id;
        }

        function playBeep(f, d) {
            const a = new AudioContext();
            const o = a.createOscillator();
            o.frequency.value = f;
            o.connect(a.destination);
            o.start(); o.stop(a.currentTime + d/1000);
        }
    </script>
</body>
</html>