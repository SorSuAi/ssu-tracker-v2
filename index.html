<!DOCTYPE html>
<html>
<head>
    <title>SSU Tracker Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; text-align: center; padding: 10px; background: #f0f2f5; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        button { padding: 15px; margin: 5px; width: 45%; font-size: 1em; border-radius: 8px; border: none; cursor: pointer; }
        .active { background: #002147; color: white; }
        input { padding: 12px; width: 80%; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; }
        #video-container { display: none; width: 100%; max-width: 400px; margin: auto; }
        video { width: 100%; border-radius: 8px; }
    </style>
</head>
<body>
    <h2>üèõÔ∏è SSU Tracker</h2>
    
    <div class="card">
        <button id="btnAttendance" class="active" onclick="setMode('Attendance')">Attendance</button>
        <button id="btnRecitation" onclick="setMode('Recitation')">Recitation</button>
    </div>

    <div class="card">
        <input type="text" id="manualId" placeholder="Manual Student ID / Name">
        <button style="width: 85%; background: #4CAF50; color: white;" onclick="submitManual()">Log Manual Entry</button>
    </div>

    <div class="card">
        <button style="width: 85%; background: #007bff; color: white;" onclick="startBarcodeScan()">üì∑ Scan Barcode/QR</button>
        <div id="video-container">
            <video id="video" autoplay></video>
        </div>
    </div>

    <p id="status">Ready to scan NFC...</p>

    <script>
        let currentMode = "Attendance";
        const scriptURL = "https://script.google.com/macros/s/AKfycbx5sZG0zIJhkB8P6LjKolCrwXXuDzfsrYWU8enK4Ln_cZS9UwcBX__PHLixbYCjnoKJ/exec";

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btnAttendance').className = (mode === 'Attendance' ? 'active' : '');
            document.getElementById('btnRecitation').className = (mode === 'Recitation' ? 'active' : '');
            document.getElementById('status').innerText = "Mode: " + mode;
        }

        // --- NFC LOGIC ---
        async function startNFC() {
            if ('NDEFReader' in window) {
                const ndef = new NDEFReader();
                await ndef.scan();
                ndef.onreading = event => processEntry(event.serialNumber);
            }
        }

        // --- BARCODE LOGIC ---
        async function startBarcodeScan() {
            const video = document.getElementById('video');
            const container = document.getElementById('video-container');
            container.style.display = "block";
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;

            const barcodeDetector = new BarcodeDetector();
            const interval = setInterval(async () => {
                try {
                    const barcodes = await barcodeDetector.detect(video);
                    if (barcodes.length > 0) {
                        clearInterval(interval);
                        stream.getTracks().forEach(t => t.stop());
                        container.style.display = "none";
                        processEntry(barcodes[0].rawValue);
                    }
                } catch (e) {}
            }, 500);
        }

        // --- MANUAL & SCORE LOGIC ---
        function submitManual() {
            const val = document.getElementById('manualId').value;
            if (val) processEntry(val);
        }

        function processEntry(id) {
            let score = "";
            if (currentMode === "Recitation") {
                score = prompt(`Enter Recitation Score for ID: ${id}`, "1");
                if (score === null) return; // Cancelled
            }
            logToSheet(id, score);
        }

        function logToSheet(id, score) {
            const finalURL = `${scriptURL}?id=${encodeURIComponent(id)}&type=${encodeURIComponent(currentMode)}&score=${encodeURIComponent(score)}`;
            
            fetch(finalURL, { method: "GET", mode: "no-cors" })
            .then(() => {
                document.getElementById('status').innerHTML = `<b style="color: green;">‚úÖ Success!</b><br>ID: ${id}`;
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                document.getElementById('manualId').value = ""; // Clear manual input
            });
        }

        window.addEventListener('click', startNFC, { once: true });
    </script>
</body>
</html>